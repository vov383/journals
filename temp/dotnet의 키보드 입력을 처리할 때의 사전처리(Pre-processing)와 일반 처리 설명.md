---
title: dotnet의 키보드 입력을 처리할 때의 사전처리(Pre-processing)와 일반 처리 설명
created: 2024-09-12 03:21
alias:
tags:
---
### 1. **사전처리 단계 (Pre-processing)**

- **사전처리**란 특정 키 입력이 애플리케이션의 일반적인 키 이벤트 처리 단계로 전달되기 전에 **시스템 또는 컨트롤에서 우선적으로 처리되는 단계**를 말합니다.
- 이 단계에서 처리된 키 입력은 더 이상 애플리케이션 내에서 추가적으로 처리되지 않으며, 이로 인해 일반적인 키 이벤트인 `KeyDown`, `KeyPress`, `KeyUp` 이벤트가 발생하지 않게 됩니다.
- 예를 들어, 방향키, `Tab` 키, `ESC` 키 같은 일부 기능 키는 시스템에서 특별한 의미를 가지기 때문에 사전처리 단계에서 사용되며, 기본 동작이 결정됩니다. 예를 들어, 방향키는 포커스를 이동시키거나 스프레드시트 컨트롤에서 셀을 이동시키는 기능을 담당합니다.

### 2. **일반 처리 단계**

- **일반 처리 단계**는 사전처리 단계에서 처리되지 않은 키 입력이 컨트롤 또는 애플리케이션으로 전달된 후 발생하는 단계입니다. 이 단계에서는 키보드 입력이 `KeyDown`, `KeyPress`, `KeyUp` 같은 이벤트를 통해 처리됩니다.
- 키가 사전처리되지 않으면, 일반 처리 단계에서 개발자가 원하는 대로 키 입력을 처리할 수 있습니다. 예를 들어, 사용자가 특정 키를 누르면 그에 대응하는 동작을 수행하도록 할 수 있습니다.

### 3. **Spread 컨트롤에서의 방향키 처리**

`Spread`와 같은 컨트롤에서 방향키나 특정 기능 키는 **사전처리 단계**에서 이미 컨트롤 내부의 동작에 사용됩니다. 예를 들어, 스프레드시트에서 방향키를 사용하면 셀을 이동시키는 동작이 발생하는데, 이 동작은 사전처리 단계에서 처리되어 일반적인 키 이벤트(`KeyDown`, `KeyPress`, `KeyUp`)가 발생하지 않습니다.

따라서, 방향키에 대한 `KeyDown` 이벤트를 사용자가 직접 처리하고 싶다면, 사전처리 단계에서 이를 가로채거나, 해당 키에 대해 별도의 처리를 적용해야 합니다.

### 4. **사전처리된 키 이벤트를 처리하는 방법**

사전처리 단계에서 처리된 키를 가로채서 처리하고자 할 때는 `ProcessCmdKey` 메서드를 오버라이드하거나 `PreviewKeyDown` 이벤트를 사용할 수 있습니다.

#### `ProcessCmdKey` 메서드 사용 예시:
이 메서드는 키 입력이 사전처리 단계에서 처리될 때 호출되므로, 이 메서드를 통해 방향키 같은 기능을 처리할 수 있습니다.

```csharp
protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
{
    if (keyData == Keys.Left || keyData == Keys.Right || keyData == Keys.Up || keyData == Keys.Down)
    {
        // 방향키가 입력되었을 때 처리할 로직
        MessageBox.Show("Arrow key pressed");
        return true;  // true를 반환하면 기본 동작을 방지
    }
    
    return base.ProcessCmdKey(ref msg, keyData);  // 기본 동작을 유지하려면 이 호출
}
```

### 5. **PreviewKeyDown 이벤트**
`PreviewKeyDown` 이벤트는 사전처리 단계에서 발생하며, 키 입력에 대한 사전 처리를 할 수 있게 해줍니다. `PreviewKeyDown`을 사용하면 방향키 같은 입력도 가로챌 수 있습니다.

```csharp
spread.PreviewKeyDown += (sender, e) =>
{
    if (e.KeyCode == Keys.Left || e.KeyCode == Keys.Right || e.KeyCode == Keys.Up || e.KeyCode == Keys.Down)
    {
        // 방향키 입력 처리
        MessageBox.Show("Arrow key pressed in PreviewKeyDown");
    }
};
```

### 결론:
- **사전처리 단계**는 키 입력이 시스템 또는 특정 컨트롤에 의해 먼저 처리되는 단계로, 이때 처리된 키는 `KeyDown`, `KeyPress`, `KeyUp` 이벤트가 발생하지 않습니다.
- 방향키처럼 사전처리 단계에서 사용되는 키 입력을 제어하려면 `ProcessCmdKey` 또는 `PreviewKeyDown` 같은 메서드를 사용해야 합니다.

### Q1: 사전처리 단계에서 처리되지 않는 키 입력을 처리할 때 추가적인 주의사항이 있을까요?

1. **키 우선순위 처리**: 사전처리 단계에서 이미 처리된 키와 일반적인 키 입력이 충돌하지 않도록 해야 합니다. 예를 들어, 특정 키가 사전처리 단계에서 처리되더라도 일반 처리 단계에서 다른 동작을 할 수 있습니다. 따라서 키 처리 우선순위를 명확히 하여 기본 동작을 방지하거나 덮어쓰는 상황을 잘 관리해야 합니다.
   
2. **키 이벤트 순서**: 키 입력에 대한 이벤트는 `KeyDown`, `KeyPress`, `KeyUp` 순으로 발생합니다. 이 순서를 알고 있으면 여러 키보드 이벤트를 적절히 처리할 수 있습니다. 사전처리 단계에서 처리된 키가 이 순서에 들어오지 않기 때문에, 다른 키 이벤트에서 그 키를 다시 처리하려면 적절한 방법을 찾아야 합니다.
   
3. **다른 키와의 충돌**: 특정 키는 운영체제나 프레임워크에 기본적으로 설정된 기능이 있을 수 있습니다(예: 방향키, Tab, ESC 등). 사전처리 단계에서 이를 재정의할 경우, 키 충돌이 발생하지 않도록 주의해야 합니다. 예를 들어, 방향키의 기본적인 포커스 이동 기능을 덮어쓸 경우 사용자 경험이 달라질 수 있습니다.

4. **컨트롤별 처리**: 사전처리 키는 컨트롤에 따라 다르게 처리될 수 있습니다. Spread 컨트롤에서는 특정 키가 사전처리되고, 일반적인 텍스트 박스에서는 동일한 키가 사전처리되지 않을 수 있습니다. 컨트롤별로 키 입력 처리 방식이 다르므로 이 차이를 고려해야 합니다.

### Q2: `ProcessCmdKey`와 `PreviewKeyDown` 이벤트의 차이점은 무엇이며, 각각 언제 사용하는 것이 적절할까요?

1. **`ProcessCmdKey` 메서드**:
   - **위치**: `ProcessCmdKey`는 폼 또는 컨트롤에서 오버라이드하는 메서드로, 모든 키 입력에 대해 시스템이 사전처리하는 단계에서 호출됩니다.
   - **주요 기능**: 방향키나 Tab, ESC 등 **기능 키**에 대한 처리에 적합합니다. 사전처리 단계에서 키 입력을 가로채는 데 유용하며, `KeyDown`, `KeyPress`, `KeyUp` 이벤트가 발생하기 전에 처리됩니다.
   - **적합한 사용 시점**: 
     - 방향키, Tab, ESC 등 **기본적으로 시스템 또는 컨트롤에서 처리하는 키 입력을 가로채고 싶을 때** 사용합니다.
     - 예를 들어, 스프레드시트에서 방향키 입력을 가로채어 셀 이동을 제어하고 싶을 때 적합합니다.
   - **코드 예시**:

     ```csharp
     protected override bool ProcessCmdKey(ref Message msg, Keys keyData)
     {
         if (keyData == Keys.Escape)
         {
             // ESC 키 입력 처리
             return true;  // 기본 동작을 방지
         }
         return base.ProcessCmdKey(ref msg, keyData);
     }
     ```

2. **`PreviewKeyDown` 이벤트**:
   - **위치**: 일반적인 이벤트로, 컨트롤에서 발생하는 이벤트입니다. 기본 키보드 처리 단계 이전에 키 입력을 처리할 수 있습니다.
   - **주요 기능**: `KeyDown` 이벤트가 발생하기 전에 키 입력을 먼저 처리할 수 있으며, 주로 **기능 키**(방향키, Tab 등)도 처리할 수 있게 해줍니다.
   - **적합한 사용 시점**:
     - **기능 키**나 방향키 같은 키에 대해 추가적인 처리를 하고 싶을 때 유용합니다.
     - 예를 들어, 방향키를 사용한 이동 외에 별도의 동작을 추가하고 싶을 때 `PreviewKeyDown`을 사용해 먼저 처리한 뒤 `KeyDown`에서 추가 작업을 할 수 있습니다.
   - **코드 예시**:

     ```csharp
     fpSpread1.PreviewKeyDown += (sender, e) =>
     {
         if (e.KeyCode == Keys.Escape)
         {
             // ESC 키 입력 처리
             e.IsInputKey = true;  // ESC 키가 입력 키로 처리되도록 설정
         }
     };
     ```

### 차이점 요약:
1. **`ProcessCmdKey`**:
   - 사전처리 단계에서 호출되어 **기본 동작을 덮어쓸 수 있음**.
   - `Tab`, 방향키 등 기능 키를 처리할 때 적합.
   - **폼 레벨**에서 키 입력을 처리할 때 주로 사용.
   
2. **`PreviewKeyDown`**:
   - 일반 처리 단계 전에 호출되지만, 사전처리된 키도 처리 가능.
   - 키 이벤트 발생 전에 **기능 키를 포함한 모든 키 입력을 사전 처리**.
   - **컨트롤 레벨**에서 키 입력을 미리 처리하고 싶을 때 사용.

### 결론:
- **`ProcessCmdKey`**는 
	- 폼이나 컨트롤에서 기본 키 동작을 완전히 제어하고자 할 때 사용합니다.
- **`PreviewKeyDown`**은 
	- 키 입력을 미리 처리하고 싶을 때, 특히 방향키 같은 기본 동작을 방지하거나 커스터마이즈할 때 유용합니다.


